Namespace Access

  Public Class WebPageItem
    Inherits CARERecord

#Region "AutoGenerated Code"

    '--------------------------------------------------
    'Enum defining all the fields in the table
    '--------------------------------------------------
    Private Enum WebPageItemFields
      AllFields = 0
      WebPageItemNumber
      WebPageItemName
      WebMenuNumber
      WebPageItemType
      WebPageUserControl
      InitialParameters
      DefaultParameters
      SubmitItemNumber
      SequenceNumber
      WebPageItemStyle
      SubmitUrl
      ParentGroupName
      ItemGroupName
      NumberOfRows
      AmendedBy
      AmendedOn
    End Enum

    '--------------------------------------------------
    'Required overrides for the class
    '--------------------------------------------------
    Protected Overrides Sub AddFields()
      With mvClassFields
        .Add("web_page_item_number", CDBField.FieldTypes.cftLong)
        .Add("web_page_item_name")
        .Add("web_menu_number", CDBField.FieldTypes.cftLong)
        .Add("web_page_item_type")
        .Add("web_page_user_control")
        .Add("initial_parameters")
        .Add("default_parameters")
        .Add("submit_item_number", CDBField.FieldTypes.cftLong)
        .Add("sequence_number", CDBField.FieldTypes.cftLong)
        .Add("web_page_item_style")
        .Add("submit_url")
        .Add("item_group_name")
        .Add("parent_group_name")
        .Add("number_of_rows", CDBField.FieldTypes.cftInteger)

        .Item(WebPageItemFields.ItemGroupName).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbDataWebPageSuppressions)
        .Item(WebPageItemFields.ParentGroupName).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbDataWebPageSuppressions)
        .Item(WebPageItemFields.NumberOfRows).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbDataWebPageSuppressions)

        .Item(WebPageItemFields.WebPageItemNumber).PrimaryKey = True
      End With
    End Sub

    Protected Overrides ReadOnly Property SupportsAmendedOnAndBy() As Boolean
      Get
        Return True
      End Get
    End Property
    Protected Overrides ReadOnly Property TableAlias() As String
      Get
        Return "wpi"
      End Get
    End Property
    Protected Overrides ReadOnly Property DatabaseTableName() As String
      Get
        Return "web_page_items"
      End Get
    End Property

    '--------------------------------------------------
    'Default constructor
    '--------------------------------------------------
    Public Sub New(ByVal pEnv As CDBEnvironment)
      MyBase.New(pEnv)
    End Sub

    '--------------------------------------------------
    'Public property procedures
    '--------------------------------------------------
    Public ReadOnly Property WebPageItemNumber() As Integer
      Get
        Return mvClassFields(WebPageItemFields.WebPageItemNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property WebPageItemName() As String
      Get
        Return mvClassFields(WebPageItemFields.WebPageItemName).Value
      End Get
    End Property
    Public ReadOnly Property WebMenuNumber() As Integer
      Get
        Return mvClassFields(WebPageItemFields.WebMenuNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property WebPageItemType() As String
      Get
        Return mvClassFields(WebPageItemFields.WebPageItemType).Value
      End Get
    End Property
    Public ReadOnly Property WebPageUserControlName() As String
      Get
        Return mvClassFields(WebPageItemFields.WebPageUserControl).Value
      End Get
    End Property
    Public ReadOnly Property InitialParameters() As String
      Get
        Return mvClassFields(WebPageItemFields.InitialParameters).Value
      End Get
    End Property
    Public ReadOnly Property DefaultParameters() As String
      Get
        Return mvClassFields(WebPageItemFields.DefaultParameters).Value
      End Get
    End Property
    Public ReadOnly Property SubmitItemNumber() As Integer
      Get
        Return mvClassFields(WebPageItemFields.SubmitItemNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property SequenceNumber() As Integer
      Get
        Return mvClassFields(WebPageItemFields.SequenceNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property AmendedBy() As String
      Get
        Return mvClassFields(WebPageItemFields.AmendedBy).Value
      End Get
    End Property
    Public ReadOnly Property AmendedOn() As String
      Get
        Return mvClassFields(WebPageItemFields.AmendedOn).Value
      End Get
    End Property
    Public ReadOnly Property WebPageItemStyle() As String
      Get
        Return mvClassFields(WebPageItemFields.WebPageItemStyle).Value
      End Get
    End Property
    Public ReadOnly Property SubmitUrl() As String
      Get
        Return mvClassFields(WebPageItemFields.SubmitUrl).Value
      End Get
    End Property
    Public ReadOnly Property ItemGroupName() As String
      Get
        Return mvClassFields(WebPageItemFields.ItemGroupName).Value
      End Get
    End Property
    Public ReadOnly Property ParentGroupName() As String
      Get
        Return mvClassFields(WebPageItemFields.ParentGroupName).Value
      End Get
    End Property
    Public ReadOnly Property NumberOfRows() As Integer
      Get
        Return mvClassFields(WebPageItemFields.NumberOfRows).IntegerValue
      End Get
    End Property
#End Region

#Region "Non-AutoGenerated Code"

    Public Sub CloneWithLinks(ByVal pEnv As CDBEnvironment, ByVal pWP As WebPage, ByVal pWPI As WebPageItem)
      Dim vLinkParams As New CDBParameters
      Dim vWPD As WebPageData

      Clone(pWPI, pWP.GetNextItemNumber)
      Save(pEnv.User.UserID)
      vLinkParams.Add("WebPageItemNumber", CDBField.FieldTypes.cftLong, WebPageItemNumber.ToString)
      vLinkParams.Add("WebPageNumber", CDBField.FieldTypes.cftLong, pWP.WebPageNumber.ToString)
      Dim vLink As New WebPageItemLink(pEnv)
      vLink.Create(vLinkParams, pWP.GetNextItemLinkNumber)
      vLink.Save(pEnv.User.UserID)
      vWPD = pWPI.WebPageData
      If vWPD.Existing Then
        Dim vNewData As New WebPageData(pEnv)
        vNewData.Clone(vWPD, WebPageItemNumber)
        vNewData.Save(pEnv.User.UserID)
      End If
    End Sub

    Protected Overrides Sub SetValid()
      MyBase.SetValid()
      If WebPageItemName.Length = 0 Then mvClassFields(WebPageItemFields.WebPageItemName).Value = "Item " & WebPageItemNumber
    End Sub

    Public Sub RevertPageControls()
      Dim vCDBControl As New CDBcontrol(mvEnv)
      vCDBControl.RevertPageControls(WebPageItemNumber, WebPageUserControl.PageCodeFromName(WebPageUserControlName))
    End Sub

    Public Overrides Sub Delete(ByVal pAmendedBy As String, ByVal pAudit As Boolean, ByVal pJournalNumber As Integer)
      Dim vField As New CDBField("web_page_item_number", WebPageItemNumber)
      mvEnv.Connection.StartTransaction()
      RevertPageControls()
      Dim vWPD As New WebPageData(mvEnv)
      vWPD.DeleteByForeignKey(vField)
      Dim vWPIL As New WebPageItemLink(mvEnv)
      vWPIL.DeleteByForeignKey(vField)
      Dim vDLI As New DisplayListItem(mvEnv)
      vDLI.DeleteByForeignKey(vField)
      MyBase.Delete(pAmendedBy, pAudit, pJournalNumber)
      mvEnv.Connection.CommitTransaction()
    End Sub

    Public ReadOnly Property WebPageData() As WebPageData
      Get
        Dim vWPD As New WebPageData(mvEnv)
        If WebPageUserControlName = "DATADISPLAY" Then
          vWPD.Init(WebPageItemNumber)
        End If
        Return vWPD
      End Get
    End Property

    Public ReadOnly Property PageCode() As String
      Get
        Return WebPageUserControl.PageCodeFromName(WebPageUserControlName)
      End Get
    End Property

    Public ReadOnly Property WebControlType() As WebPageUserControl.WebControlTypes
      Get
        Return WebPageUserControl.ControlTypeFromName(WebPageUserControlName)
      End Get
    End Property

    Public ReadOnly Property CustomisationRequired() As Boolean
      Get
        Select Case WebPageUserControl.ControlTypeFromName(WebPageUserControlName)
          Case WebPageUserControl.WebControlTypes.wctAddCategoryCheckboxes, _
               WebPageUserControl.WebControlTypes.wctAddCategoryOptions, _
               WebPageUserControl.WebControlTypes.wctAddCategoryNotes
            Return True
        End Select
      End Get
    End Property

    Public Function ItemDataTable() As CDBDataTable
      Dim vDT As New CDBDataTable
      Select Case WebControlType
        Case WebPageUserControl.WebControlTypes.wctAddCategoryCheckboxes, _
             WebPageUserControl.WebControlTypes.wctAddCategoryOptions, _
             WebPageUserControl.WebControlTypes.wctAddCategoryNotes
          'Find the Activity 
          Dim vActivity As String = ""
          Dim vParameters() As String = DefaultParameters.Split(","c)
          For Each vParameter As String In vParameters
            If vParameter.StartsWith("Activity") Then
              vActivity = vParameter.Substring(9)
              Exit For
            End If
          Next
          Dim vSQLStatement As SQLStatement
          Dim vWhereFields As New CDBFields()
          vWhereFields.Add("av.activity", vActivity)
          vSQLStatement = New SQLStatement(mvEnv.Connection, "activity_value, activity_value_desc", "activity_values av", vWhereFields, "activity_value_desc")
          vDT.FillFromSQL(mvEnv, vSQLStatement, True)
      End Select
      Return vDT
    End Function

    Public Sub SetSubmitPage(ByVal pNewWebPageNumber As Integer)
      mvClassFields(WebPageItemFields.SubmitItemNumber).IntegerValue = pNewWebPageNumber
    End Sub
#End Region
  End Class
End Namespace
