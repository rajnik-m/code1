Namespace Access

  Public Class WebControl
    Inherits CARERecord

#Region "AutoGenerated Code"

    '--------------------------------------------------
    'Enum defining all the fields in the table
    '--------------------------------------------------
    Private Enum WebControlFields
      AllFields = 0
      WebNumber
      WebName
      WebUrl
      WebPageNumber
      HeaderItemNumber
      FooterItemNumber
      LoginPageNumber
      NextPageNumber
      NextItemNumber
      NextItemLinkNumber
      NextMenuNumber
      NextMenuItemNumber
      LeftPanelItemNumber
      RightPanelItemNumber
      UpdateDetailsPageNumber
      AmendedBy
      AmendedOn
    End Enum

    '--------------------------------------------------
    'Required overrides for the class
    '--------------------------------------------------
    Protected Overrides Sub AddFields()
      With mvClassFields
        .Add("web_number", CDBField.FieldTypes.cftLong)
        .Add("web_name")
        .Add("web_url")
        .Add("web_page_number", CDBField.FieldTypes.cftLong)
        .Add("header_item_number", CDBField.FieldTypes.cftLong)
        .Add("footer_item_number", CDBField.FieldTypes.cftLong)
        .Add("login_page_number", CDBField.FieldTypes.cftLong)
        .Add("next_page_number", CDBField.FieldTypes.cftLong)
        .Add("next_item_number", CDBField.FieldTypes.cftLong)
        .Add("next_item_link_number", CDBField.FieldTypes.cftLong)
        .Add("next_menu_number", CDBField.FieldTypes.cftLong)
        .Add("next_menu_item_number", CDBField.FieldTypes.cftLong)
        .Add("left_panel_item_number", CDBField.FieldTypes.cftLong)
        .Add("right_panel_item_number", CDBField.FieldTypes.cftLong)
        .Add("update_details_page_number", CDBField.FieldTypes.cftLong)

        .Item(WebControlFields.WebNumber).PrimaryKey = True
        .Item(WebControlFields.LeftPanelItemNumber).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbDataControlReadonlyAndPanels)
        .Item(WebControlFields.RightPanelItemNumber).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbDataControlReadonlyAndPanels)
        .Item(WebControlFields.UpdateDetailsPageNumber).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbGrabDetailsOption)
        .SetControlNumberField(WebControlFields.WebNumber, "WB")
      End With
    End Sub

    Protected Overrides ReadOnly Property SupportsAmendedOnAndBy() As Boolean
      Get
        Return True
      End Get
    End Property
    Protected Overrides ReadOnly Property TableAlias() As String
      Get
        Return "wc"
      End Get
    End Property
    Protected Overrides ReadOnly Property DatabaseTableName() As String
      Get
        Return "web_controls"
      End Get
    End Property

    '--------------------------------------------------
    'Default constructor
    '--------------------------------------------------
    Public Sub New(ByVal pEnv As CDBEnvironment)
      MyBase.New(pEnv)
    End Sub

    '--------------------------------------------------
    'Public property procedures
    '--------------------------------------------------
    Public ReadOnly Property WebNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.WebNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property WebName() As String
      Get
        Return mvClassFields(WebControlFields.WebName).Value
      End Get
    End Property
    Public ReadOnly Property WebUrl() As String
      Get
        Return mvClassFields(WebControlFields.WebUrl).Value
      End Get
    End Property
    Public ReadOnly Property WebPageNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.WebPageNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property AmendedBy() As String
      Get
        Return mvClassFields(WebControlFields.AmendedBy).Value
      End Get
    End Property
    Public ReadOnly Property AmendedOn() As String
      Get
        Return mvClassFields(WebControlFields.AmendedOn).Value
      End Get
    End Property
    Public Property HeaderItemNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.HeaderItemNumber).IntegerValue
      End Get
      Set(ByVal pValue As Integer)
        mvClassFields(WebControlFields.HeaderItemNumber).IntegerValue = pValue
      End Set
    End Property
    Public Property FooterItemNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.FooterItemNumber).IntegerValue
      End Get
      Set(ByVal pValue As Integer)
        mvClassFields(WebControlFields.FooterItemNumber).IntegerValue = pValue
      End Set
    End Property
    Public Property LeftPanelItemNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.LeftPanelItemNumber).IntegerValue
      End Get
      Set(ByVal pValue As Integer)
        mvClassFields(WebControlFields.LeftPanelItemNumber).IntegerValue = pValue
      End Set
    End Property
    Public Property RightPanelItemNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.RightPanelItemNumber).IntegerValue
      End Get
      Set(ByVal pValue As Integer)
        mvClassFields(WebControlFields.RightPanelItemNumber).IntegerValue = pValue
      End Set
    End Property
    Public ReadOnly Property LoginPageNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.LoginPageNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property NextPageNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.NextPageNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property NextItemNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.NextItemNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property NextItemLinkNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.NextItemLinkNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property NextMenuNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.NextMenuNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property NextMenuItemNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.NextMenuItemNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property UpdateDetailsPageNumber() As Integer
      Get
        Return mvClassFields(WebControlFields.UpdateDetailsPageNumber).IntegerValue
      End Get
    End Property
#End Region

#Region "Non-AutoGenerated Code"

    Private Const MAX_ITEMS_PER_WEB As Integer = 99999
    Private Const ITEMS_MULTIPLIER As Integer = MAX_ITEMS_PER_WEB + 1

    Public Enum WebNumberFields
      wnfPageNumber
      wnfItemNumber
      wnfItemLinkNumber
      wnfMenuNumber
      wnfMenuItemNumber
    End Enum

    Protected Overrides Sub SetDefaults()
      mvClassFields(WebControlFields.NextPageNumber).IntegerValue = 1
      mvClassFields(WebControlFields.NextItemNumber).IntegerValue = 1
      mvClassFields(WebControlFields.NextItemLinkNumber).IntegerValue = 1
      mvClassFields(WebControlFields.NextMenuNumber).IntegerValue = 1
      mvClassFields(WebControlFields.NextMenuItemNumber).IntegerValue = 1
    End Sub

    Public Overrides ReadOnly Property DataTable() As CDBDataTable
      Get
        Dim vDT As CDBDataTable = MyBase.DataTable
        Dim vWPD As New WebPageData(mvEnv)
                vDT.AddColumnsFromList("HeaderHtml,FooterHtml,LeftPanelHtml,RightPanelHtml")
        Dim vRow As CDBDataRow = vDT.Rows(0)
        If HeaderItemNumber > 0 Then
          vWPD.Init(HeaderItemNumber)
          vRow.Item("HeaderHtml") = vWPD.PageHtml
        End If
        If FooterItemNumber > 0 Then
          vWPD.Init(FooterItemNumber)
          vRow.Item("FooterHtml") = vWPD.PageHtml
        End If
        If LeftPanelItemNumber > 0 Then
          vWPD.Init(LeftPanelItemNumber)
          vRow.Item("LeftPanelHtml") = vWPD.PageHtml
        End If
        If RightPanelItemNumber > 0 Then
          vWPD.Init(RightPanelItemNumber)
          vRow.Item("RightPanelHtml") = vWPD.PageHtml
        End If
        Return vDT
      End Get
    End Property

    Public Sub DeleteWeb()
      Dim vWhereFields As New CDBFields
      Dim vTransactionStarted As Boolean
      If mvEnv.Connection.InTransaction = False Then
        mvEnv.Connection.StartTransaction()
        vTransactionStarted = True
      End If
      vWhereFields.Clear()
      vWhereFields.Add("web_page_number", BaseItemNumber, CDBField.FieldWhereOperators.fwoBetweenFrom)
      vWhereFields.Add("wc.web_page_number", MaxItemNumber, CDBField.FieldWhereOperators.fwoBetweenTo)
      mvEnv.Connection.DeleteRecords("web_pages", vWhereFields, False)
      mvEnv.Connection.DeleteRecords("web_page_item_links", vWhereFields, False)
      vWhereFields.Clear()
      vWhereFields.Add("web_page_item_number", BaseItemNumber, CDBField.FieldWhereOperators.fwoBetweenFrom)
      vWhereFields.Add("wc.web_page_item_number", MaxItemNumber, CDBField.FieldWhereOperators.fwoBetweenTo)
      mvEnv.Connection.DeleteRecords("web_page_items", vWhereFields, False)
      mvEnv.Connection.DeleteRecords("web_page_data", vWhereFields, False)
      vWhereFields.Clear()
      vWhereFields.Add("web_menu_number", BaseItemNumber, CDBField.FieldWhereOperators.fwoBetweenFrom)
      vWhereFields.Add("wc.web_menu_number", MaxItemNumber, CDBField.FieldWhereOperators.fwoBetweenTo)
      mvEnv.Connection.DeleteRecords("web_menus", vWhereFields, False)
      mvEnv.Connection.DeleteRecords("web_menu_items", vWhereFields, False)
      vWhereFields.Clear()
      vWhereFields.Add("fp_application", BaseItemNumber, CDBField.FieldWhereOperators.fwoBetweenFrom)
      vWhereFields.Add("fp_application#2", MaxItemNumber, CDBField.FieldWhereOperators.fwoBetweenTo)
      vWhereFields.Add("fp_page_type", "W*", CDBField.FieldWhereOperators.fwoLike)
      mvEnv.Connection.DeleteRecords("fp_controls", vWhereFields, False)
      If vTransactionStarted Then mvEnv.CommitOutstandingTransaction()
    End Sub

    Public Function AllocateNextNumber(ByVal pWebNumberField As WebNumberFields) As Integer
      Dim vWhereFields As New CDBFields
      Dim vCount As Integer
      Dim vRetries As Integer
      Dim vFieldIndex As WebControlFields

      Select Case pWebNumberField
        Case WebNumberFields.wnfPageNumber
          vFieldIndex = WebControlFields.NextPageNumber
        Case WebNumberFields.wnfItemNumber
          vFieldIndex = WebControlFields.NextItemNumber
        Case WebNumberFields.wnfItemLinkNumber
          vFieldIndex = WebControlFields.NextItemLinkNumber
        Case WebNumberFields.wnfMenuNumber
          vFieldIndex = WebControlFields.NextMenuNumber
        Case WebNumberFields.wnfMenuItemNumber
          vFieldIndex = WebControlFields.NextMenuItemNumber
      End Select
      Dim vNumber As Integer
      Do
        vNumber = mvClassFields.Item(vFieldIndex).LongValue
        vWhereFields.Clear()
        vWhereFields.Add(mvClassFields.Item(WebControlFields.WebNumber).Name, CDBField.FieldTypes.cftLong, WebNumber.ToString)
        vWhereFields.Add(mvClassFields.Item(vFieldIndex).Name, CDBField.FieldTypes.cftLong, vNumber.ToString)
        mvClassFields.Item(vFieldIndex).IntegerValue = vNumber + 1
        vCount = mvEnv.Connection.UpdateRecords(mvClassFields.DatabaseTableName, mvClassFields.UpdateFields, vWhereFields, False)
        vRetries += 1
        If vCount = 0 Then Init(WebNumber) 'Re-read the web record
      Loop While vCount = 0 And vRetries < mvEnv.MaxRetries
      If vCount = 0 Then RaiseError(DataAccessErrors.daeAllocateEventNumber, mvClassFields.Item(vFieldIndex).Name, mvClassFields.Item(WebControlFields.WebNumber).Value)
      Return BaseItemNumber + vNumber
    End Function

    Public ReadOnly Property BaseItemNumber() As Integer
      Get
        Return mvClassFields.Item(WebControlFields.WebNumber).IntegerValue * ITEMS_MULTIPLIER
      End Get
    End Property

    Public Shared ReadOnly Property ItemsMultiplier() As Integer
      Get
        Return ITEMS_MULTIPLIER
      End Get
    End Property

    Public ReadOnly Property MaxItemNumber() As Integer
      Get
        Return (mvClassFields.Item(WebControlFields.WebNumber).IntegerValue * ITEMS_MULTIPLIER) + MAX_ITEMS_PER_WEB
      End Get
    End Property

    Public Function PageURL(ByVal pPageNumber As Integer) As String
      Return String.Format("{0}/default.aspx?pn={1}", WebUrl, pPageNumber)
    End Function

#End Region

  End Class
End Namespace
