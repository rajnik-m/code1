Namespace Access

  Public Class TelemarketingContact
    Inherits CARERecord

#Region "AutoGenerated Code"

'--------------------------------------------------
'Enum defining all the fields in the table
'--------------------------------------------------
    Private Enum TelemarketingContactFields
      AllFields = 0
      SelectionSet
      ContactNumber
      AddressNumber
      CanCall
      LastCallTime
      CallBackTime
      NumberOfFailures
      InUseBy
      AmendedBy
      AmendedOn
    End Enum

'--------------------------------------------------
'Required overrides for the class
'--------------------------------------------------
    Protected Overrides Sub AddFields()
      With mvClassFields
        .Add("selection_set", CDBField.FieldTypes.cftLong)
        .Add("contact_number", CDBField.FieldTypes.cftLong)
        .Add("address_number", CDBField.FieldTypes.cftLong)
        .Add("can_call")
        .Add("last_call_time", CDBField.FieldTypes.cftTime)
        .Add("call_back_time", CDBField.FieldTypes.cftTime)
        .Add("number_of_failures", CDBField.FieldTypes.cftLong)
        .Add("in_use_by")

        .Item(TelemarketingContactFields.SelectionSet).PrimaryKey = True
        .Item(TelemarketingContactFields.ContactNumber).PrimaryKey = True
      End With
    End Sub

    Protected Overrides ReadOnly Property SupportsAmendedOnAndBy() As Boolean
      Get
        Return True
      End Get
    End Property
    Protected Overrides ReadOnly Property TableAlias() As String
      Get
        Return "tc"
      End Get
    End Property
    Protected Overrides ReadOnly Property DatabaseTableName() As String
      Get
        Return "telemarketing_contacts"
      End Get
    End Property

'--------------------------------------------------
'Default constructor
'--------------------------------------------------
    Public Sub New(ByVal pEnv As CDBEnvironment)
      MyBase.New(pEnv)
    End Sub

'--------------------------------------------------
'Public property procedures
'--------------------------------------------------
    Public ReadOnly Property SelectionSet() As Integer
      Get
        Return mvClassFields(TelemarketingContactFields.SelectionSet).IntegerValue
      End Get
    End Property
    Public ReadOnly Property ContactNumber() As Integer
      Get
        Return mvClassFields(TelemarketingContactFields.ContactNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property AddressNumber() As Integer
      Get
        Return mvClassFields(TelemarketingContactFields.AddressNumber).IntegerValue
      End Get
    End Property
    Public Property CanCall() As Boolean
      Get
        Return mvClassFields(TelemarketingContactFields.CanCall).Bool
      End Get
      Set(ByVal value As Boolean)
        mvClassFields(TelemarketingContactFields.CanCall).Bool = value
      End Set
    End Property
    Public Property LastCallTime() As String
      Get
        Return mvClassFields(TelemarketingContactFields.LastCallTime).Value
      End Get
      Set(ByVal value As String)
        mvClassFields(TelemarketingContactFields.LastCallTime).Value = value
      End Set
    End Property
    Public Property CallBackTime() As String
      Get
        Return mvClassFields(TelemarketingContactFields.CallBackTime).Value
      End Get
      Set(ByVal value As String)
        mvClassFields(TelemarketingContactFields.CallBackTime).Value = value
      End Set
    End Property
    Public ReadOnly Property NumberOfFailures() As Integer
      Get
        Return mvClassFields(TelemarketingContactFields.NumberOfFailures).IntegerValue
      End Get
    End Property
    Public Property InUseBy() As String
      Get
        Return mvClassFields(TelemarketingContactFields.InUseBy).Value
      End Get
      Set(ByVal value As String)
        mvClassFields(TelemarketingContactFields.InUseBy).Value = value
      End Set
    End Property
    Public ReadOnly Property AmendedBy() As String
      Get
        Return mvClassFields(TelemarketingContactFields.AmendedBy).Value
      End Get
    End Property
    Public ReadOnly Property AmendedOn() As String
      Get
        Return mvClassFields(TelemarketingContactFields.AmendedOn).Value
      End Get
    End Property
#End Region

#Region "Non-AutoGenerated Code"

    Public Sub InitNextContact(ByVal pSelectionSetNo As Integer)
      MyBase.Init()
      Dim vWhereFields As New CDBFields
      vWhereFields.Add("selection_set", pSelectionSetNo)
      vWhereFields.Add("can_call", "Y")
      vWhereFields.Add("in_use_by", "", CDBField.FieldWhereOperators.fwoNullOrEqual)
      Dim vNumbOfFailures As Integer = IntegerValue(mvEnv.GetConfig("ma_number_of_failures", "9999"))
      If vNumbOfFailures = 0 Then vNumbOfFailures = 9999
      vWhereFields.Add("number_of_failures", vNumbOfFailures, CDBField.FieldWhereOperators.fwoNullOrLessThan)

      Dim vOrderBy As New StringBuilder
      vOrderBy.Append(mvEnv.Connection.DBOrderByNullsLastAsc("call_back_time"))
      vOrderBy.Append(",")
      vOrderBy.Append(mvEnv.Connection.DBIsNull("number_of_failures", "0"))
      vOrderBy.Append(", amended_on")

      Dim vTable As DataTable = New SQLStatement(mvEnv.Connection, GetRecordSetFields(), mvClassFields.TableNameAndAlias, vWhereFields, vOrderBy.ToString).GetDataTable
      Dim vCurrentTime As Date = Now
      Dim vRowToBeUsed As DataRow = Nothing
      For Each vRow As DataRow In vTable.Rows
        If vRow("call_back_time").ToString.Length > 0 Then
          If DateTime.Parse(vRow("call_back_time").ToString) <= vCurrentTime OrElse DateTime.Parse(vRow("call_back_time").ToString) <= vCurrentTime.AddMinutes(5) Then
            vRowToBeUsed = vRow
          End If
        Else
          vRowToBeUsed = vRow
        End If
        If vRowToBeUsed IsNot Nothing Then Exit For
      Next
      If vRowToBeUsed IsNot Nothing Then InitFromDataRow(vRowToBeUsed, False)
    End Sub

    Public Sub IncreaseNumberOfFailures()
      mvClassFields(TelemarketingContactFields.NumberOfFailures).IntegerValue += 1
    End Sub

#End Region
  End Class
End Namespace
