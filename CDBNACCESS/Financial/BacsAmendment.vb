Namespace Access

  Public Class BacsAmendment
    Inherits CARERecord

#Region "AutoGenerated Code"

    '--------------------------------------------------
    'Enum defining all the fields in the table
    '--------------------------------------------------
    Private Enum BacsAmendmentFields
      AllFields = 0
      BacsAmendmentNumber
      UserNumber
      BacsRecordType
      EffectiveDate
      AdviceReference
      PayersName
      PayersAccountNumber
      PayersSortCode
      AdviceDueDate
      BacsPaymentFrequency
      AmountOfPayment
      BacsAdviceReason
      PayersNewName
      PayersNewAccountNumber
      PayersNewSortCode
      NewDueDate
      NewBacsPaymentFrequency
      NewAmountOfPayment
      LastPaymentDate
      OriginatorsSequenceNo
      BuildingSocietyRollNo1
      BuildingSocietyRollNo2
      BuildingSocietyRollNo3
      BacsTransactionCode
      OriginatorsSortCode
      OriginatorsAccountNumber
      BacsNotes
      DirectDebitNumber
      OldBankDetailsNumber
      NewBankDetailsNumber
      Notes
      JulianDate
      OriginatorsAccountName
      BacsMsgProcessed
      BacsErrorCode
      JobNumber
      PayersIbanNumber
      PayersBicCode
      OriginatorsIbanNumber
      OriginatorsBicCode
      EndToEndId
      AmendedBy
      AmendedOn
    End Enum

    '--------------------------------------------------
    'Required overrides for the class
    '--------------------------------------------------
    Protected Overrides Sub AddFields()
      With mvClassFields
        .Add("bacs_amendment_number", CDBField.FieldTypes.cftLong)
        .Add("user_number")
        .Add("bacs_record_type").PrefixRequired = True
        .Add("effective_date", CDBField.FieldTypes.cftDate)
        .Add("advice_reference")
        .Add("payers_name")
        .Add("payers_account_number")
        .Add("payers_sort_code")
        .Add("advice_due_date", CDBField.FieldTypes.cftDate)
        .Add("bacs_payment_frequency")
        .Add("amount_of_payment", CDBField.FieldTypes.cftNumeric)
        .Add("bacs_advice_reason")
        .Add("payers_new_name")
        .Add("payers_new_account_number")
        .Add("payers_new_sort_code")
        .Add("new_due_date", CDBField.FieldTypes.cftDate)
        .Add("new_bacs_payment_frequency")
        .Add("new_amount_of_payment", CDBField.FieldTypes.cftNumeric)
        .Add("last_payment_date", CDBField.FieldTypes.cftDate)
        .Add("originators_sequence_no")
        .Add("building_society_roll_no_1")
        .Add("building_society_roll_no_2")
        .Add("building_society_roll_no_3")
        .Add("bacs_transaction_code")
        .Add("originators_sort_code")
        .Add("originators_account_number")
        .Add("bacs_notes")
        .Add("direct_debit_number", CDBField.FieldTypes.cftLong)
        .Add("old_bank_details_number", CDBField.FieldTypes.cftLong)
        .Add("new_bank_details_number", CDBField.FieldTypes.cftLong)
        .Add("notes", CDBField.FieldTypes.cftMemo)
        .Add("julian_date")
        .Add("originators_account_name")
        .Add("bacs_msg_processed")
        .Add("bacs_error_code")
        .Add("job_number")
        .Add("payers_iban_number")
        .Add("payers_bic_code")
        .Add("originators_iban_number")
        .Add("originators_bic_code")
        .Add("end_to_end_id")
        .Item(BacsAmendmentFields.BacsAmendmentNumber).PrimaryKey = True
        .SetControlNumberField(BacsAmendmentFields.BacsAmendmentNumber, "BA")
        .Item(BacsAmendmentFields.BacsMsgProcessed).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbBACSErrorCode)
        .Item(BacsAmendmentFields.BacsErrorCode).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbBACSErrorCode)
        .Item(BacsAmendmentFields.JobNumber).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbBACSErrorCode)
        .Item(BacsAmendmentFields.PayersIbanNumber).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbIbanBicNumbers)
        .Item(BacsAmendmentFields.PayersBicCode).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbIbanBicNumbers)
        .Item(BacsAmendmentFields.OriginatorsIbanNumber).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbIbanBicNumbers)
        .Item(BacsAmendmentFields.OriginatorsBicCode).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbIbanBicNumbers)
        .Item(BacsAmendmentFields.EndToEndId).InDatabase = mvEnv.GetDataStructureInfo(CDBEnvironment.cdbDataStructureConstants.cdbBacsEndToEndId)
      End With
    End Sub

    Protected Overrides ReadOnly Property SupportsAmendedOnAndBy() As Boolean
      Get
        Return True
      End Get
    End Property
    Protected Overrides ReadOnly Property TableAlias() As String
      Get
        Return "ba"
      End Get
    End Property
    Protected Overrides ReadOnly Property DatabaseTableName() As String
      Get
        Return "bacs_amendments"
      End Get
    End Property

    '--------------------------------------------------
    'Default constructor
    '--------------------------------------------------
    Public Sub New(ByVal pEnv As CDBEnvironment)
      MyBase.New(pEnv)
    End Sub

    '--------------------------------------------------
    'Public property procedures
    '--------------------------------------------------
    Public ReadOnly Property BacsAmendmentNumber() As Integer
      Get
        Return mvClassFields(BacsAmendmentFields.BacsAmendmentNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property UserNumber() As String
      Get
        Return mvClassFields(BacsAmendmentFields.UserNumber).Value
      End Get
    End Property
    Public ReadOnly Property BacsRecordType() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsRecordType).Value
      End Get
    End Property
    Public ReadOnly Property EffectiveDate() As String
      Get
        Return mvClassFields(BacsAmendmentFields.EffectiveDate).Value
      End Get
    End Property
    Public ReadOnly Property AdviceReference() As String
      Get
        Return mvClassFields(BacsAmendmentFields.AdviceReference).Value
      End Get
    End Property
    Public ReadOnly Property PayersName() As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersName).Value
      End Get
    End Property
    Public ReadOnly Property PayersAccountNumber() As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersAccountNumber).Value
      End Get
    End Property
    Public ReadOnly Property PayersSortCode() As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersSortCode).Value
      End Get
    End Property
    Public ReadOnly Property AdviceDueDate() As String
      Get
        Return mvClassFields(BacsAmendmentFields.AdviceDueDate).Value
      End Get
    End Property
    Public ReadOnly Property BacsPaymentFrequency() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsPaymentFrequency).Value
      End Get
    End Property
    Public ReadOnly Property AmountOfPayment() As Double
      Get
        Return mvClassFields(BacsAmendmentFields.AmountOfPayment).DoubleValue
      End Get
    End Property
    Public ReadOnly Property BacsAdviceReason() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsAdviceReason).Value
      End Get
    End Property
    Public ReadOnly Property PayersNewName() As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersNewName).Value
      End Get
    End Property
    Public ReadOnly Property PayersNewAccountNumber() As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersNewAccountNumber).Value
      End Get
    End Property
    Public ReadOnly Property PayersNewSortCode() As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersNewSortCode).Value
      End Get
    End Property
    Public ReadOnly Property NewDueDate() As String
      Get
        Return mvClassFields(BacsAmendmentFields.NewDueDate).Value
      End Get
    End Property
    Public ReadOnly Property NewBacsPaymentFrequency() As String
      Get
        Return mvClassFields(BacsAmendmentFields.NewBacsPaymentFrequency).Value
      End Get
    End Property
    Public ReadOnly Property NewAmountOfPayment() As Double
      Get
        Return mvClassFields(BacsAmendmentFields.NewAmountOfPayment).DoubleValue
      End Get
    End Property
    Public ReadOnly Property LastPaymentDate() As String
      Get
        Return mvClassFields(BacsAmendmentFields.LastPaymentDate).Value
      End Get
    End Property
    Public ReadOnly Property OriginatorsSequenceNo() As String
      Get
        Return mvClassFields(BacsAmendmentFields.OriginatorsSequenceNo).Value
      End Get
    End Property
    Public ReadOnly Property BuildingSocietyRollNo1() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BuildingSocietyRollNo1).Value
      End Get
    End Property
    Public ReadOnly Property BuildingSocietyRollNo2() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BuildingSocietyRollNo2).Value
      End Get
    End Property
    Public ReadOnly Property BuildingSocietyRollNo3() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BuildingSocietyRollNo3).Value
      End Get
    End Property
    Public ReadOnly Property BacsTransactionCode() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsTransactionCode).Value
      End Get
    End Property
    Public ReadOnly Property OriginatorsSortCode() As String
      Get
        Return mvClassFields(BacsAmendmentFields.OriginatorsSortCode).Value
      End Get
    End Property
    Public ReadOnly Property OriginatorsAccountNumber() As String
      Get
        Return mvClassFields(BacsAmendmentFields.OriginatorsAccountNumber).Value
      End Get
    End Property
    Public ReadOnly Property BacsNotes() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsNotes).Value
      End Get
    End Property
    Public ReadOnly Property DirectDebitNumber() As Integer
      Get
        Return mvClassFields(BacsAmendmentFields.DirectDebitNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property OldBankDetailsNumber() As Integer
      Get
        Return mvClassFields(BacsAmendmentFields.OldBankDetailsNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property NewBankDetailsNumber() As Integer
      Get
        Return mvClassFields(BacsAmendmentFields.NewBankDetailsNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property Notes() As String
      Get
        Return mvClassFields(BacsAmendmentFields.Notes).Value
      End Get
    End Property
    Public ReadOnly Property AmendedBy() As String
      Get
        Return mvClassFields(BacsAmendmentFields.AmendedBy).Value
      End Get
    End Property
    Public ReadOnly Property AmendedOn() As String
      Get
        Return mvClassFields(BacsAmendmentFields.AmendedOn).Value
      End Get
    End Property
    Public ReadOnly Property JulianDate() As String
      Get
        Return mvClassFields(BacsAmendmentFields.JulianDate).Value
      End Get
    End Property
    Public ReadOnly Property OriginatorsAccountName() As String
      Get
        Return mvClassFields(BacsAmendmentFields.OriginatorsAccountName).Value
      End Get
    End Property
    Public ReadOnly Property BacsMsgProcessed() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsMsgProcessed).Value
      End Get
    End Property
    Public ReadOnly Property BacsMsgErrorCode() As String
      Get
        Return mvClassFields(BacsAmendmentFields.BacsErrorCode).Value
      End Get
    End Property
    Public ReadOnly Property JobNumber() As Integer
      Get
        Return mvClassFields(BacsAmendmentFields.JobNumber).IntegerValue
      End Get
    End Property
    Public ReadOnly Property PayersIbanNumber As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersIbanNumber).Value
      End Get
    End Property
    Public ReadOnly Property PayersBicCode As String
      Get
        Return mvClassFields(BacsAmendmentFields.PayersBicCode).Value
      End Get
    End Property
    Public ReadOnly Property OriginatorsIbanNumber As String
      Get
        Return mvClassFields(BacsAmendmentFields.OriginatorsIbanNumber).Value
      End Get
    End Property
    Public ReadOnly Property OriginatorsBicCode As String
      Get
        Return mvClassFields(BacsAmendmentFields.OriginatorsBicCode).Value
      End Get
    End Property
    Public ReadOnly Property EndToEndId As String
      Get
        Return mvClassFields(BacsAmendmentFields.EndToEndId).Value
      End Get
    End Property
#End Region

#Region " Non AutoGenerated Code"
    Public Enum BACSSource
      None
      brbsADDACS
      brbsAWACS
      brbsAUDDIS
      brbsARUDD
      brbsVerWinfo
      brbsCare 'CARE-specific format currently used for processing VerWinfo files (users can not select this type)
      brbsCamt053
      brbsSEPAPain002
    End Enum

    Private Enum BACSFileFields 'ADDACS & AUDDIS (+ AWACS except for fields 15 - 18) Files
      UserNumber = 1
      RecordType
      AdviceEffectiveDate
      AdviceReference
      PayersName '5
      PayersAccountNumber
      PayersSortCode
      AdviceDueDate
      PaymentFrequency
      AmountOfPayment '10
      AdviceReasonCode
      PayersNewName
      PayersNewAccountNumber
      PayersNewSortCode
      NewDueDate '15
      NewPaymentFrequency
      NewAmountOfPayment
      LastPaymentDate '18
      OriginatorsSequenceNumber
      TransactionCode '20
      OriginatorsSortCode
      OriginatorsAccountNumber
      BacsNotes '23
    End Enum

    Private Enum AWACSFields 'AWACS Files have fields 15 to 18 different
      BuildingSocRoll1 = 15
      BuildingSocRoll2
      BuildingSocRoll3
      Filler
    End Enum

    Private Enum ARUDDFields 'ARUDD File Format
      UserNumber = 1
      RecordType
      AdvicePayersSortCode
      AdvicePayersAccountNumber
      Space1 '5
      TransactionCode
      RecipientSortCode
      RecipientAccountNumber
      AdviceReasonCode
      JulianDate '10
      Amount
      RecipientAccountName
      AdviceReference
      Space2 '14
    End Enum

    Private Enum CareBacsFields 'CARE-specific files (geneated from VerWinfo files)
      FileType = 1
      RecordType
      AdviceReasonCode
      UserNumber
      PayersAccountNumber
      PayersDDNumber
      RecipientAccountNumber
      Amount
      EffectiveDate
      AdviceDueDate
    End Enum

    Private mvBACSSource As BACSSource = BACSSource.None
    Private mvDDNumber As Integer

    Public Sub InitFromBacsFile(ByVal pBacsSource As BACSSource, ByVal pCSVFile As FileReader)
      MyBase.Init()
      '  DirectDebitNumber
      '  OldBankDetailsNumber
      '  NewBankDetailsNumber
      '  Notes

      mvBACSSource = pBacsSource
      mvDDNumber = 0

      Select Case pBacsSource
        Case BACSSource.brbsADDACS, BACSSource.brbsAUDDIS, BACSSource.brbsAWACS
          With mvClassFields
            .Item(BacsAmendmentFields.UserNumber).Value = pCSVFile.TrimmedItem(BACSFileFields.UserNumber)
            .Item(BacsAmendmentFields.BacsRecordType).Value = pCSVFile.TrimmedItem(BACSFileFields.RecordType)
            .Item(BacsAmendmentFields.EffectiveDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(BACSFileFields.AdviceEffectiveDate)).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.BacsAdviceReason).Value = pCSVFile.TrimmedItem(BACSFileFields.AdviceReasonCode)
            .Item(BacsAmendmentFields.PayersName).Value = ProperCase(pCSVFile.TrimmedItem(BACSFileFields.PayersName))
            .Item(BacsAmendmentFields.PayersAccountNumber).Value = pCSVFile.TrimmedItem(BACSFileFields.PayersAccountNumber)
            .Item(BacsAmendmentFields.PayersSortCode).Value = pCSVFile.TrimmedItem(BACSFileFields.PayersSortCode)
            .Item(BacsAmendmentFields.AdviceDueDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(BACSFileFields.AdviceDueDate)).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.BacsPaymentFrequency).Value = pCSVFile.TrimmedItem(BACSFileFields.PaymentFrequency)
            .Item(BacsAmendmentFields.AmountOfPayment).Value = pCSVFile.TrimmedItem(BACSFileFields.AmountOfPayment)
            .Item(BacsAmendmentFields.BacsAdviceReason).Value = pCSVFile.TrimmedItem(BACSFileFields.AdviceReasonCode)
            .Item(BacsAmendmentFields.PayersNewName).Value = ProperCase(pCSVFile.TrimmedItem(BACSFileFields.PayersNewName))
            .Item(BacsAmendmentFields.PayersNewAccountNumber).Value = pCSVFile.TrimmedItem(BACSFileFields.PayersNewAccountNumber)
            .Item(BacsAmendmentFields.PayersNewSortCode).Value = pCSVFile.TrimmedItem(BACSFileFields.PayersNewSortCode)
            .Item(BacsAmendmentFields.AdviceReference).Value = pCSVFile.TrimmedItem(BACSFileFields.AdviceReference)
            If pBacsSource = BACSSource.brbsAWACS Then
              .Item(BacsAmendmentFields.BuildingSocietyRollNo1).Value = pCSVFile.TrimmedItem(AWACSFields.BuildingSocRoll1)
              .Item(BacsAmendmentFields.BuildingSocietyRollNo2).Value = pCSVFile.TrimmedItem(AWACSFields.BuildingSocRoll2)
              .Item(BacsAmendmentFields.BuildingSocietyRollNo3).Value = pCSVFile.TrimmedItem(AWACSFields.BuildingSocRoll3)
            Else
              If pCSVFile.TrimmedItem(BACSFileFields.NewDueDate).Length = 6 Then
                .Item(BacsAmendmentFields.NewDueDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(BACSFileFields.NewDueDate)).ToString(CAREDateFormat)
              End If
              .Item(BacsAmendmentFields.NewBacsPaymentFrequency).Value = pCSVFile.TrimmedItem(BACSFileFields.NewPaymentFrequency)
              .Item(BacsAmendmentFields.NewAmountOfPayment).Value = pCSVFile.TrimmedItem(BACSFileFields.NewAmountOfPayment)
              If pCSVFile.TrimmedItem(BACSFileFields.LastPaymentDate).Length = 6 Then
                .Item(BacsAmendmentFields.LastPaymentDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(BACSFileFields.LastPaymentDate)).ToString(CAREDateFormat)
              End If
            End If
            .Item(BacsAmendmentFields.OriginatorsSequenceNo).Value = pCSVFile.TrimmedItem(BACSFileFields.OriginatorsSequenceNumber)
            If pBacsSource = BACSSource.brbsADDACS Then
              'Nothing else
            Else
              .Item(BacsAmendmentFields.BacsTransactionCode).Value = pCSVFile.TrimmedItem(BACSFileFields.TransactionCode)
              .Item(BacsAmendmentFields.OriginatorsAccountNumber).Value = pCSVFile.TrimmedItem(BACSFileFields.OriginatorsAccountNumber)
              .Item(BacsAmendmentFields.OriginatorsSortCode).Value = pCSVFile.TrimmedItem(BACSFileFields.OriginatorsSortCode)
              .Item(BacsAmendmentFields.BacsNotes).Value = pCSVFile.TrimmedItem(BACSFileFields.BacsNotes)
            End If
          End With


        Case BACSSource.brbsARUDD
          With mvClassFields
            .Item(BacsAmendmentFields.UserNumber).Value = pCSVFile.TrimmedItem(ARUDDFields.UserNumber)
            .Item(BacsAmendmentFields.BacsRecordType).Value = pCSVFile.TrimmedItem(ARUDDFields.RecordType)
            .Item(BacsAmendmentFields.PayersSortCode).Value = pCSVFile.TrimmedItem(ARUDDFields.AdvicePayersSortCode)
            .Item(BacsAmendmentFields.PayersAccountNumber).Value = pCSVFile.TrimmedItem(ARUDDFields.AdvicePayersAccountNumber)
            .Item(BacsAmendmentFields.BacsTransactionCode).Value = pCSVFile.TrimmedItem(ARUDDFields.TransactionCode)
            .Item(BacsAmendmentFields.OriginatorsSortCode).Value = pCSVFile.TrimmedItem(ARUDDFields.RecipientSortCode)
            .Item(BacsAmendmentFields.OriginatorsAccountNumber).Value = pCSVFile.TrimmedItem(ARUDDFields.RecipientAccountNumber)
            .Item(BacsAmendmentFields.BacsAdviceReason).Value = pCSVFile.TrimmedItem(ARUDDFields.AdviceReasonCode)
            .Item(BacsAmendmentFields.JulianDate).Value = pCSVFile.TrimmedItem(ARUDDFields.JulianDate)
            .Item(BacsAmendmentFields.OriginatorsAccountName).Value = ProperCase(pCSVFile.TrimmedItem(ARUDDFields.RecipientAccountName))
            .Item(BacsAmendmentFields.AdviceReference).Value = pCSVFile.TrimmedItem(ARUDDFields.AdviceReference)
            .Item(BacsAmendmentFields.EffectiveDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(ARUDDFields.JulianDate)).ToString(CAREDateFormat)
            'AdvicedueDate
            Dim vAmount As String = pCSVFile.TrimmedItem(ARUDDFields.Amount)
            Dim vDblAmount As Double
            If vAmount.Length > 0 Then
              If vAmount.Contains(".") = False Then
                vDblAmount = DoubleValue(vAmount) / 100
              Else
                vDblAmount = DoubleValue(vAmount)
              End If
              .Item(BacsAmendmentFields.AmountOfPayment).Value = vDblAmount.ToString
            End If
          End With

        Case BACSSource.brbsCare
          'VerWinfo
          'PayersSortCode gets set from the DD at insert (Holland do not use Sort Codes)
          With mvClassFields
            .Item(BacsAmendmentFields.UserNumber).Value = pCSVFile.TrimmedItem(CareBacsFields.UserNumber)
            .Item(BacsAmendmentFields.BacsRecordType).Value = pCSVFile.TrimmedItem(CareBacsFields.RecordType)
            .Item(BacsAmendmentFields.PayersAccountNumber).Value = pCSVFile.TrimmedItem(CareBacsFields.PayersAccountNumber)
            .Item(BacsAmendmentFields.PayersSortCode).Value = "000000"
            .Item(BacsAmendmentFields.BacsAdviceReason).Value = If(pCSVFile.TrimmedItem(CareBacsFields.AdviceReasonCode).Length > 0, pCSVFile.TrimmedItem(CareBacsFields.AdviceReasonCode), "0").ToString
            .Item(BacsAmendmentFields.OriginatorsAccountNumber).Value = pCSVFile.TrimmedItem(CareBacsFields.RecipientAccountNumber)
            .Item(BacsAmendmentFields.AdviceDueDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(CareBacsFields.AdviceDueDate)).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.AdviceReference).Value = pCSVFile.TrimmedItem(CareBacsFields.PayersDDNumber)
            If pCSVFile.TrimmedItem(CareBacsFields.EffectiveDate).Length = 6 Then
              .Item(BacsAmendmentFields.EffectiveDate).Value = GetDatefromBacs(pCSVFile.TrimmedItem(CareBacsFields.EffectiveDate)).ToString(CAREDateFormat)
            Else
              .Item(BacsAmendmentFields.EffectiveDate).Value = .Item(BacsAmendmentFields.AdviceDueDate).Value
            End If
            Dim vAmount As String = pCSVFile.TrimmedItem(CareBacsFields.Amount)
            If vAmount.Length > 0 Then
              Dim vDblAmount As Double = DoubleValue(vAmount) / 100
              .Item(BacsAmendmentFields.AmountOfPayment).Value = vDblAmount.ToString
            End If
            mvDDNumber = IntegerValue(pCSVFile.TrimmedItem(CareBacsFields.PayersDDNumber))
          End With

      End Select
    End Sub
    Public Sub InitFromBacsFile(ByVal pBacsSource As BACSSource, ByVal pColumns As System.Data.DataColumnCollection, ByVal pRow As DataRow)
      InitFromBacsFile(pBacsSource, pColumns, pRow, Nothing, Nothing, "", "")
    End Sub
    Public Sub InitFromBacsFile(ByVal pBacsSource As BACSSource, ByVal pColumns As System.Data.DataColumnCollection, ByVal pRow As DataRow, ByVal pAruddOrigRow As DataRow, ByVal pAruddDebitItemRow As DataRow, ByVal pAruddEffectiveDate As String, ByVal pAruddUserNumber As String)
      MyBase.Init()

      mvBACSSource = pBacsSource
      mvDDNumber = 0

      Select Case pBacsSource
        Case BACSSource.brbsADDACS, BACSSource.brbsAUDDIS, BACSSource.brbsAWACS
          With mvClassFields
            .Item(BacsAmendmentFields.UserNumber).Value = GetBacsField(pColumns, pRow, "user-number")
            If pBacsSource = BACSSource.brbsADDACS Then
              .Item(BacsAmendmentFields.BacsRecordType).Value = GetBacsField(pColumns, pRow, "record-type", "A")
            ElseIf pBacsSource = BACSSource.brbsAWACS Then
              .Item(BacsAmendmentFields.BacsRecordType).Value = GetBacsField(pColumns, pRow, "record-type", "W")
            Else
              .Item(BacsAmendmentFields.BacsRecordType).Value = GetBacsField(pColumns, pRow, "record-type")
            End If
            Dim vDate As String = GetBacsField(pColumns, pRow, "effective-date")
            If vDate.Length > 0 Then .Item(BacsAmendmentFields.EffectiveDate).Value = GetDatefromBacs(vDate).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.AdviceReference).Value = GetBacsField(pColumns, pRow, "reference")
            .Item(BacsAmendmentFields.PayersName).Value = ProperCase(GetBacsField(pColumns, pRow, "payer-name"))
            .Item(BacsAmendmentFields.PayersAccountNumber).Value = GetBacsField(pColumns, pRow, "payer-account-number")
            .Item(BacsAmendmentFields.PayersSortCode).Value = GetBacsField(pColumns, pRow, "payer-sort-code")
            If pBacsSource = BACSSource.brbsADDACS Then
              vDate = GetBacsField(pColumns, pRow, "due-date", TodaysDate)
              .Item(BacsAmendmentFields.AdviceDueDate).Value = GetDatefromBacs(vDate).ToString(CAREDateFormat)
            End If
            .Item(BacsAmendmentFields.BacsPaymentFrequency).Value = GetBacsField(pColumns, pRow, "payment-frequency")
            .Item(BacsAmendmentFields.BacsAdviceReason).Value = GetBacsField(pColumns, pRow, "reason-code")
            If pBacsSource = BACSSource.brbsADDACS Then
              .Item(BacsAmendmentFields.PayersNewName).Value = GetBacsField(pColumns, pRow, "payer-new-name")
            End If
            .Item(BacsAmendmentFields.PayersNewAccountNumber).Value = GetBacsField(pColumns, pRow, "payer-new-account-number")
            Dim vSortCode As String = GetBacsField(pColumns, pRow, "payer-new-sort-code-number")
            If vSortCode.Length = 0 Then vSortCode = GetBacsField(pColumns, pRow, "payer-new-sort-code")
            .Item(BacsAmendmentFields.PayersNewSortCode).Value = vSortCode
            If pBacsSource = BACSSource.brbsADDACS OrElse pBacsSource = BACSSource.brbsAWACS Then
              vDate = GetBacsField(pColumns, pRow, "new-due-date")
              If vDate.Length > 0 Then .Item(BacsAmendmentFields.NewDueDate).Value = GetDatefromBacs(vDate).ToString(CAREDateFormat)
              .Item(BacsAmendmentFields.NewBacsPaymentFrequency).Value = GetBacsField(pColumns, pRow, "new-payment-frequency")
              vDate = GetBacsField(pColumns, pRow, "last-payment-date")
              If vDate.Length > 0 Then .Item(BacsAmendmentFields.LastPaymentDate).Value = GetDatefromBacs(vDate).ToString(CAREDateFormat)
            End If
            '.Item(BacsAmendmentFields.NewAmountOfPayment).Value = GetBacsField(pColumns,pRow,"amount-of-new-payment")
            .Item(BacsAmendmentFields.OriginatorsSequenceNo).Value = GetBacsField(pColumns, pRow, "aosn")
            If pBacsSource = BACSSource.brbsAUDDIS OrElse pBacsSource = BACSSource.brbsAWACS Then
              .Item(BacsAmendmentFields.BacsTransactionCode).Value = GetBacsField(pColumns, pRow, "transaction-code")
              .Item(BacsAmendmentFields.OriginatorsSortCode).Value = GetBacsField(pColumns, pRow, "orig-sort-code")
              .Item(BacsAmendmentFields.OriginatorsAccountNumber).Value = GetBacsField(pColumns, pRow, "orig-account-number")
              .Item(BacsAmendmentFields.OriginatorsAccountName).Value = ProperCase(GetBacsField(pColumns, pRow, "originator-name"))
            End If
            If pBacsSource = BACSSource.brbsAWACS Then
              .Item(BacsAmendmentFields.BuildingSocietyRollNo1).Value = GetBacsField(pColumns, pRow, "building-society-roll-number")
            End If
            'Amount
            'ADDACS / AWACS - Amount of new payment
            'For of both of the above need to retrieve amount from pRow and format two 2 decimal places (if amount is in pence only then need to make it £ & pence first)
          End With

        Case BACSSource.brbsARUDD
          With mvClassFields
            If pAruddOrigRow IsNot Nothing Then
              Dim vOrigColumns As System.Data.DataColumnCollection = pAruddOrigRow.Table.Columns
              .Item(BacsAmendmentFields.OriginatorsAccountName).Value = GetBacsField(vOrigColumns, pAruddOrigRow, "name")
              .Item(BacsAmendmentFields.OriginatorsAccountNumber).Value = GetBacsField(vOrigColumns, pAruddOrigRow, "number")
              .Item(BacsAmendmentFields.OriginatorsSortCode).Value = ProperSortCode(GetBacsField(vOrigColumns, pAruddOrigRow, "sortCode"))
            End If
            If pAruddDebitItemRow IsNot Nothing Then
              Dim vDebitItemColumns As System.Data.DataColumnCollection = pAruddDebitItemRow.Table.Columns
              .Item(BacsAmendmentFields.AdviceReference).Value = GetBacsField(vDebitItemColumns, pAruddDebitItemRow, "ref")
              Dim vAdviceReason As String = GetBacsField(vDebitItemColumns, pAruddDebitItemRow, "returnCode")
              If vAdviceReason.Length >= 1 Then .Item(BacsAmendmentFields.BacsAdviceReason).Value = vAdviceReason.Substring(0, 1)
              Dim vAmount As String = GetBacsField(vDebitItemColumns, pAruddDebitItemRow, "valueOf")
              Dim vDblAmount As Double
              If vAmount.Length > 0 Then
                If vAmount.Contains(".") = False Then
                  vDblAmount = DoubleValue(vAmount) / 100
                Else
                  vDblAmount = DoubleValue(vAmount)
                End If
                .Item(BacsAmendmentFields.AmountOfPayment).Value = vDblAmount.ToString
              End If
            End If
            .Item(BacsAmendmentFields.UserNumber).Value = pAruddUserNumber
            .Item(BacsAmendmentFields.BacsRecordType).Value = GetBacsField(pColumns, pRow, "record-type", "U")
            .Item(BacsAmendmentFields.PayersAccountNumber).Value = GetBacsField(pColumns, pRow, "number")
            .Item(BacsAmendmentFields.PayersSortCode).Value = ProperSortCode(GetBacsField(pColumns, pRow, "sortcode"))
            .Item(BacsAmendmentFields.EffectiveDate).Value = GetDatefromBacs(pAruddEffectiveDate).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.JulianDate).Value = SetJulianFromDate(GetDatefromBacs(pAruddEffectiveDate).ToString(CAREDateFormat), True)
          End With
      End Select
    End Sub
    ''' <summary>
    ''' This method will set all the calss fields with the values read from the CAMt053 file to store them in the BACS Amendments table for processing.
    ''' </summary>
    ''' <param name="pBacsSource">BACS source code  = "brbsCamt053"</param>
    ''' <param name="pPayersIban">Payers IBAN Number</param>
    ''' <param name="pPayersName">Payers Name</param>
    ''' <param name="pAdvicesDate">Advice Date</param>
    ''' <param name="pAmount">Amount od Direct debit that was rejected</param>
    ''' <param name="pEndToEndId">Unique transaction identifier</param>
    ''' <param name="pAdviceReason">Rejection reason</param>
    ''' <param name="pPayersBic">Payers BIC Code</param>  
    ''' <param name="pAdviceRefrence">DD mandate</param> 
    ''' <param name="pPayeesIban">Iban of the payee</param>
    ''' <param name="pPayeesBic">Business Identifier Code of the Payee, ISO 9362</param>
    ''' <remarks></remarks>
    Public Sub InitFromBacsFile(ByVal pBacsSource As BACSSource, ByVal pPayersIban As String, ByVal pPayersBic As String, ByVal pPayersName As String, ByVal pAdvicesDate As String, ByVal pAmount As String, ByVal pEndToEndId As String, ByVal pAdviceReason As String, ByVal pAdviceRefrence As String, ByVal pPayeesIban As String, ByVal pPayeesBic As String)
      MyBase.Init()
      mvBACSSource = pBacsSource
      Select Case pBacsSource
        Case BACSSource.brbsCamt053
          With mvClassFields
            .Item(BacsAmendmentFields.UserNumber).Value = mvEnv.GetControlValue(CDBEnvironment.cdbControlConstants.cdbControlBacsUserNumber)
            .Item(BacsAmendmentFields.PayersIbanNumber).Value = pPayersIban
            .Item(BacsAmendmentFields.PayersName).Value = TruncatePayerName(pPayersName) 'BR18329
            .Item(BacsAmendmentFields.BacsRecordType).Value = "C"
            .Item(BacsAmendmentFields.PayersBicCode).Value = pPayersBic
            .Item(BacsAmendmentFields.AdviceDueDate).Value = GetDatefromBacs(pAdvicesDate).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.EffectiveDate).Value = GetDatefromBacs(pAdvicesDate).ToString(CAREDateFormat)
            .Item(BacsAmendmentFields.AmountOfPayment).Value = pAmount
            .Item(BacsAmendmentFields.OriginatorsIbanNumber).Value = pPayeesIban 'BR18521
            .Item(BacsAmendmentFields.OriginatorsBicCode).Value = pPayeesBic 'BR18521
            If pAdviceRefrence.Length > 0 Then
              .Item(BacsAmendmentFields.AdviceReference).Value = pAdviceRefrence
            Else
              .Item(BacsAmendmentFields.AdviceReference).Value = "UNKNOWN"
            End If
            .Item(BacsAmendmentFields.BacsAdviceReason).Value = pAdviceReason
            .Item(BacsAmendmentFields.EndToEndId).Value = pEndToEndId
          End With
      End Select
    End Sub

    Public Sub InitFromBacsFile(ByVal pBacsSource As BACSSource, ByVal pXMLNode As Xml.XmlNode, ByVal pXMLNSManager As Xml.XmlNamespaceManager)
      MyBase.Init()
      Me.BACSFileSource = pBacsSource

      Dim vNamespacePrefix As String = pXMLNSManager.LookupPrefix(pXMLNSManager.DefaultNamespace)
      If String.IsNullOrWhiteSpace(vNamespacePrefix) Then vNamespacePrefix = "ns" 'The prefix (ns) is arbitrary and can be anything

      mvClassFields.Item(BacsAmendmentFields.UserNumber).Value = mvEnv.GetControlValue(CDBEnvironment.cdbControlConstants.cdbControlBacsUserNumber)

      Select Case Me.BACSFileSource
        Case BACSSource.brbsSEPAPain002
          If pXMLNode.Name.ToLower.Equals("txinfandsts") Then
            mvClassFields.Item(BacsAmendmentFields.BacsRecordType).Value = "P"

            If pXMLNode.HasChildNodes Then
              Dim vBaseNode As Xml.XmlNode = GetXMLNode(pXMLNode, pXMLNSManager, "OrgnlTxRef", vNamespacePrefix)
              Dim vChildNode As Xml.XmlNode = Nothing

              'AdvideDueDate & EffectiveDate
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "ReqdColltnDt", vNamespacePrefix)
              If vChildNode IsNot Nothing Then
                Dim vDate As Date = GetDatefromBacs(vChildNode.InnerText)
                mvClassFields.Item(BacsAmendmentFields.AdviceDueDate).Value = vDate.ToString(CAREDateFormat)
                mvClassFields.Item(BacsAmendmentFields.EffectiveDate).Value = vDate.ToString(CAREDateFormat)
              End If
              'AdviceReference
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "MndtId", vNamespacePrefix)    'MndtRltdInf
              If vChildNode IsNot Nothing Then
                mvClassFields.Item(BacsAmendmentFields.AdviceReference).Value = vChildNode.InnerText
              End If
              'PayersName
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "Dbtr", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                Dim vNameNode As Xml.XmlNode = GetXMLNode(vChildNode, pXMLNSManager, "Nm", vNamespacePrefix)
                If vNameNode IsNot Nothing Then
                  mvClassFields.Item(BacsAmendmentFields.PayersName).Value = vNameNode.InnerText
                End If
              End If
              'AmountOfPayment
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "InstdAmt", vNamespacePrefix)    'Amt
              If vChildNode IsNot Nothing Then
                mvClassFields.Item(BacsAmendmentFields.AmountOfPayment).Value = vChildNode.InnerText
              End If
              'OriginatorsSequenceNumber
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "CdtrSchmeId", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                Dim vIDNodes As Xml.XmlNodeList = vChildNode.SelectNodes(String.Format(".//{0}:{1}", vNamespacePrefix, "Id"), pXMLNSManager) 'There are multiple Id nodes!!
                If vIDNodes IsNot Nothing AndAlso vIDNodes.Count > 0 Then
                  Dim vIDNode As Xml.XmlNode = vIDNodes(vIDNodes.Count - 1) 'Get the last node
                  If vIDNode IsNot Nothing Then
                    mvClassFields.Item(BacsAmendmentFields.OriginatorsSequenceNo).Value = vIDNode.InnerText
                  End If
                End If
              End If
              'OriginatorsAccountName
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "Cdtr", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                Dim vNameNode As Xml.XmlNode = GetXMLNode(vChildNode, pXMLNSManager, "Nm", vNamespacePrefix)
                If vNameNode IsNot Nothing Then
                  mvClassFields.Item(BacsAmendmentFields.OriginatorsAccountName).Value = vNameNode.InnerText
                End If
              End If
              'PayersIbanNumber
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "DbtrAcct", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                vChildNode = GetXMLNode(vChildNode, pXMLNSManager, "IBAN", vNamespacePrefix)
                If vChildNode IsNot Nothing Then
                  mvClassFields.Item(BacsAmendmentFields.PayersIbanNumber).Value = vChildNode.InnerText
                End If
              End If
              'PayersBicCode
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "DbtrAgt", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                vChildNode = GetXMLNode(vChildNode, pXMLNSManager, "BIC", vNamespacePrefix)
                If vChildNode IsNot Nothing Then
                  mvClassFields.Item(BacsAmendmentFields.PayersBicCode).Value = vChildNode.InnerText
                End If
              End If
              'OriginatorsIbanNumber
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "CdtrAcct", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                vChildNode = GetXMLNode(vChildNode, pXMLNSManager, "IBAN", vNamespacePrefix)
                If vChildNode IsNot Nothing Then
                  mvClassFields.Item(BacsAmendmentFields.OriginatorsIbanNumber).Value = vChildNode.InnerText
                End If
              End If
              'OriginatorsBicCode
              vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "CdtrAgt", vNamespacePrefix)
              If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                vChildNode = GetXMLNode(vChildNode, pXMLNSManager, "BIC", vNamespacePrefix)
                If vChildNode IsNot Nothing Then
                  mvClassFields.Item(BacsAmendmentFields.OriginatorsBicCode).Value = vChildNode.InnerText
                End If
              End If

              'BacsAdviceReason
              vBaseNode = GetXMLNode(pXMLNode, pXMLNSManager, "StsRsnInf", vNamespacePrefix)
              If vBaseNode IsNot Nothing AndAlso vBaseNode.HasChildNodes = True Then
                vChildNode = GetXMLNode(vBaseNode, pXMLNSManager, "Rsn", vNamespacePrefix)
                If vChildNode IsNot Nothing AndAlso vChildNode.HasChildNodes = True Then
                  vChildNode = GetXMLNode(vChildNode, pXMLNSManager, "Cd", vNamespacePrefix)
                  If vChildNode IsNot Nothing Then
                    mvClassFields.Item(BacsAmendmentFields.BacsAdviceReason).Value = vChildNode.InnerText
                  End If
                End If
              End If

              'EndToEndId
              vBaseNode = GetXMLNode(pXMLNode, pXMLNSManager, "OrgnlEndToEndId", vNamespacePrefix)
              If vBaseNode IsNot Nothing Then
                mvClassFields.Item(BacsAmendmentFields.EndToEndId).Value = vBaseNode.InnerText
              End If
            End If
          Else
            Throw New NotImplementedException(String.Format("XML Node '{0}' is not supported", pXMLNode.Name))
          End If
      End Select
    End Sub

    Public Property BACSFileSource() As BACSSource
      Get
        If mvBACSSource = BacsAmendment.BACSSource.None Then GetBACSSource()
        Return mvBACSSource
      End Get
      Private Set(value As BACSSource)
        mvBACSSource = value
      End Set
    End Property

    Private Function GetDatefromBacs(ByVal pDateString As String) As Date
      Dim vDate As Date = CDate(TodaysDate())
      Try
        If mvBACSSource <> BACSSource.brbsARUDD AndAlso pDateString.Length = 6 Then
          'Format = DDMMYY
          If mvBACSSource = BACSSource.brbsCare Then
            vDate = DateSerial(IntegerValue(pDateString.Substring(0, 2)), IntegerValue(pDateString.Substring(2, 2)), IntegerValue(pDateString.Substring(4)))
          Else
            vDate = DateSerial(IntegerValue(pDateString.Substring(4)), IntegerValue(pDateString.Substring(2, 2)), IntegerValue(pDateString.Substring(0, 2)))
          End If
        ElseIf mvBACSSource = BACSSource.brbsARUDD AndAlso pDateString.Length = 3 Then
          'Format = Number of days ionto the current year
          'Date = 01January of current Year
          '       Plus Julian Date days
          '       Less 1 Day
          'If resulting Date after today then deduct 1 year
          vDate = DateSerial(vDate.Year, 1, 1)
          vDate = vDate.AddDays(DoubleValue(pDateString))
          vDate = vDate.AddDays(-1)
          If vDate > CDate(TodaysDate()) Then vDate = vDate.AddYears(-1)
        ElseIf pDateString.Length = 10 Then
          'Format = YYYY-MM-DD
          vDate = DateSerial(IntegerValue(pDateString.Substring(0, 4)), IntegerValue(pDateString.Substring(5, 2)), IntegerValue(pDateString.Substring(8, 2)))
        End If
      Catch vEX As Exception
        'Date was in an invalid format
        vDate = CDate(TodaysDate())
      End Try
      Return vDate
    End Function

    Private Function GetBacsField(ByVal pColumns As System.Data.DataColumnCollection, ByVal pRow As DataRow, ByVal pItem As String) As String
      Return GetBacsField(pColumns, pRow, pItem, "")
    End Function
    Private Function GetBacsField(ByVal pColumns As System.Data.DataColumnCollection, ByVal pRow As DataRow, ByVal pItem As String, ByVal pDefault As String) As String
      Dim vReturnString As String = ""
      Try
        If pColumns.Contains(pItem) Then
          vReturnString = pRow(pItem).ToString().Trim() 'BR18566
        Else
          vReturnString = pDefault
        End If
      Catch vEX As Exception
        'Cannot find column
        vReturnString = ""
      End Try
      Return vReturnString
    End Function

    Private Function GetXMLNode(ByVal pBaseNode As Xml.XmlNode, ByVal pXMLNSManager As Xml.XmlNamespaceManager, ByVal pNodeName As String, ByVal pNamespacePrefix As String) As Xml.XmlNode
      Dim vNode As Xml.XmlNode = Nothing

      Try
        vNode = pBaseNode.SelectSingleNode(String.Format(".//{0}:{1}", pNamespacePrefix, pNodeName), pXMLNSManager)   'The .// ensures that only matching child nodes of the current node are selected rather than all nodes in the document
      Catch ex As Exception
        vNode = Nothing
      End Try

      Return vNode
    End Function

    Private Function ProperCase(ByVal pName As String) As String
      If pName.Length > 0 Then
        Return StrConv(pName.Replace("_", " "), VbStrConv.ProperCase)
      Else
        Return ""
      End If
    End Function

    Private Function ProperSortCode(ByVal pSortCode As String) As String
      If pSortCode.Length > 0 Then
        Return pSortCode.Replace("-", "")
      Else
        Return ""
      End If
    End Function

    Protected Overrides Sub SetDefaults()
      MyBase.SetDefaults()
      mvClassFields.Item(BacsAmendmentFields.BacsMsgProcessed).Value = "N"
    End Sub

    Protected Overrides Sub ClearFields()
      MyBase.ClearFields()
      mvBACSSource = BACSSource.None
      mvDDNumber = 0
    End Sub

    Private Function GetBACSSource() As BACSSource
      Select Case mvClassFields.Item(BacsAmendmentFields.BacsRecordType).Value
        Case "A"
          mvBACSSource = BacsAmendment.BACSSource.brbsADDACS
        Case "B", "E"
          mvBACSSource = BacsAmendment.BACSSource.brbsVerWinfo
        Case "C"
          mvBACSSource = BacsAmendment.BACSSource.brbsCamt053
        Case "D", "N", "R", "S", "V"
          mvBACSSource = BacsAmendment.BACSSource.brbsAUDDIS
        Case "P"
          mvBACSSource = BACSSource.brbsSEPAPain002
        Case "U"
          mvBACSSource = BacsAmendment.BACSSource.brbsARUDD
        Case "W"
          mvBACSSource = BacsAmendment.BACSSource.brbsAWACS
        Case Else
          mvBACSSource = BacsAmendment.BACSSource.None
      End Select
      Return mvBACSSource
    End Function

    ''' <summary>Validate the BACS data for BACS Messaging, returning the error code for any invalid data.</summary>
    ''' <param name="pErrorCode">Error code identifying the invalid data</param>
    ''' <returns>For any invalid date, the error code is returned</returns>
    Public Function ValidateBACSData(ByRef pErrorCode As String) As Boolean
      Dim vValid As Boolean = True

      If mvExisting Then
        Select Case BACSFileSource
          Case BACSSource.brbsAUDDIS, BACSSource.brbsADDACS
            'These fields are only present in the AUDDIS & ADDACS files
            'If Due Date / Amount of Payment / Payment Frequency have changed then do not process
            If NewDueDate.Length > 0 Then
              If AdviceDueDate <> NewDueDate Then
                vValid = False
                pErrorCode = "DDDC"   'The Direct Debit Due Date has been changed
              End If
            End If
            If NewAmountOfPayment > 0 Then
              If AmountOfPayment <> NewAmountOfPayment Then
                vValid = False
                pErrorCode = "DDAC"   'The Direct Debit Payment Amount has been changed
              End If
            End If
            If NewBacsPaymentFrequency.Length > 0 Then
              If BacsPaymentFrequency <> NewBacsPaymentFrequency Then
                vValid = False
                pErrorCode = "DDFC"   'The Direct Debit Payment Frequency has been changed
              End If
            End If

          Case BACSSource.brbsARUDD
            If UserNumber.Length = 0 Then
              vValid = False
              pErrorCode = "USNM"   'BACS User Name missing
            End If
            If BacsRecordType.Length = 0 Then
              vValid = False
              pErrorCode = "BRTM"   'BACS Record Type missing
            End If
            If AdviceReference.Length = 0 Then
              vValid = False
              pErrorCode = "DDRM"   'Direct Debit Reference is missing
            End If
            If JulianDate.Length = 0 Then
              vValid = False
              pErrorCode = "BJDM"   'The Julian Date is missing
            End If

          Case BACSSource.brbsCare, BACSSource.brbsVerWinfo
            If UserNumber.Length = 0 Then
              vValid = False
              pErrorCode = "USNM"   'BACS User Name missing
            End If
            If BacsRecordType.Length = 0 Then
              vValid = False
              pErrorCode = "BRTM"   'BACS Record Type missing
            End If
            If AdviceDueDate.Length = 0 Then
              vValid = False
              pErrorCode = "ADDM"   'BACS Advice Due Date is missing
            End If
            'If DirectDebitNumber = 0 Then
            '  vValid = False
            '  pErrorCode = "DDNM"   'Direct Debit Number is missing
            'End If
            If AdviceReference.Length = 0 Then
              vValid = False
              pErrorCode = "DDRM"   'Direct Debit Reference is missing
            End If
          Case BACSSource.brbsSEPAPain002
            If String.IsNullOrEmpty(PayersIbanNumber) = True Then
              vValid = False
              pErrorCode = "PPIM"   'Payers IBAN is missing
            End If
        End Select

        'These fields are present in all file types. If any of them are not supplied then do not process
        Select Case BACSFileSource
          Case BACSSource.brbsARUDD, BACSSource.brbsCare, BACSSource.brbsVerWinfo, BACSSource.brbsCamt053
            'Do Nothing
          Case Else
            If UserNumber.Length = 0 Then
              vValid = False
              pErrorCode = "USNM"   'BACS User Name missing
            End If
            If BacsRecordType.Length = 0 Then
              vValid = False
              pErrorCode = "BRTM"   'BACS Record Type missing
            End If
            If EffectiveDate.Length = 0 Then
              vValid = False
              pErrorCode = "AEDM"   'BACS Advice Effective Date is missing
            End If
            If AdviceReference.Length = 0 Then
              vValid = False
              pErrorCode = "DDRM"   'Direct Debit Reference is missing
            End If
            If PayersName.Length = 0 Then
              vValid = False
              pErrorCode = "PYNM"   'Payers Name is missing
            End If
            If OriginatorsSequenceNo.Length = 0 Then
              vValid = False
              pErrorCode = "ORSM"   'BACS Originators Sequence Number is missing
            End If
        End Select
      End If

      Return vValid
    End Function
    ''' <summary>
    ''' Truncate the payers name to the length of payer name on bacs_amendments based on table maintenance_attributes BR18329
    ''' </summary>
    ''' <param name="pPayersName">payers name to be truncated</param>
    ''' <returns>The payers name truncated</returns>
    ''' <remarks>entry_length on maintenance_attributes is T-SQL smallint</remarks>
    Public Function TruncatePayerName(pPayersName As String) As String
      Dim vAttributeLength As Integer = 0

      Dim vSQLStatement As SQLStatement
      Dim vTableName As String = "maintenance_attributes"
      Dim vDataTable As DataTable
      Dim vWhereFields As CDBFields = New CDBFields()

      vWhereFields.Add(New CDBField("table_name", "bacs_amendments", CDBField.FieldWhereOperators.fwoEqual))
      vWhereFields.Add(New CDBField("attribute_name", "payers_name", CDBField.FieldWhereOperators.fwoEqual))
      vSQLStatement = New SQLStatement(mvEnv.Connection, "attribute_name, type, entry_length", vTableName, vWhereFields)
      vDataTable = vSQLStatement.GetDataTable
      vAttributeLength = CInt(vDataTable.Rows(0).Item("entry_length"))
      Return Utilities.Common.Substring(pPayersName, 0, vAttributeLength) 'Safe if pPayersName.length < vAttributeLength
    End Function
#End Region

  End Class
End Namespace
